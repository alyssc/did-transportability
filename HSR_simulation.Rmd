---
title: "Data Generating Mechanism Testing"
output: pdf_document
---

```{r, include=FALSE}
library(boot)
library(Rlab)
#library(ramify)
options(digits=3)
```

We create a single instantiation of the simulation in this block: 

```{r}
source("HSR_simulation_fn.R", local = knitr::knit_global())
source("HSR_param_calib.R", local = knitr::knit_global())
global_params <- data.frame(
  x1.r = -.617, 
  x2.r = -.715,
  phi.1= -.18, phi.2=-.06, 
  
  q= -1.38,
  om.1= -.165,
  om.2= -3.2,
  om.3= -.235,
  
  H = 0, sigma.H = 0.02,
  psi.1=-.03, 
  
  theta.P = -68.5, sigma.P =0, 
  gamma.3=-92, 
  gamma.4 = 206, 
  gamma.5 = -87,
  
  beta.0 = -3.05,
  beta.3=0,
  beta.4 = .839,
  beta.5 = 1.17,
  beta.6 = .778, 
  
  alpha.0 = 10100,
  alpha.1 = 46500 , 
  alpha.2 = 600,
  alpha.3 = 12,
  
  P= 1200 # number of practices in a region
  
)
```

Here, I test our ability to estimate the PATT (using 3 estimators) and also calculate the true PATT: 

```{r}
df <- make_regions(global_params)
df <- tibble::as_tibble(df)
estimate_patt(df)
true_patt(df)
```


DID EXAMPLE IN-SAMPLE: 

Running diff-in-diff in-sample: 

```{r}
lm.did(df,plot=T)
plot.did(df)
```


```{r}
df %>% 
  ggplot( aes(x=U, color=factor(S, levels = c("0","1")),fill=factor(S, levels = c("0","1")))) + 
  geom_density(alpha=.3)
```

```{r}
results <- sim_plot_patt(global_params,"psi.1",c(-.1,0,.1),nsim=5)
plot_patt(results, var_name = "psi.1")
```

```{r}
p <- c( .1)
log(p/(1-p))

q <- c( .18) 
log( (q*(1-p))/(p*(1-q)) )
```


```{r,include=F}
# Drafting parameter test graphs (TO-DO: overlay on one graph)
par(mfrow=c(1,2))
hist(df[df$S==1,]$b, main = "Hist of b, CPC+ regions")
hist(df[df$S==0,]$b, main = "Hist of b, non-CPC+ regions")

```

